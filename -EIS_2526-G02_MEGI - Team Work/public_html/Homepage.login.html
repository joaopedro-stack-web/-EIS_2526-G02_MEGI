<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <title>Collector's Dashboard</title>
  <link rel="stylesheet" href="stylewith.css">

  <!-- ROTAS para o Collecta Navigation Kit -->
  <meta name="app-base" content="">
  <meta name="item-page-path" content="index.html">
  <meta name="events-page-path" content="event.html">
  <meta name="collection-page-path" content="collection-page.html">
  <meta name="collectors-page-path" content="Homepage.login.html">
  <meta name="community-page-path" content="team_page2.html">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    /* FORÇA o design do See More na Home */
    a.see-more{
      display:inline-flex !important;
      align-items:center !important;
      justify-content:center !important;

      margin:16px auto 0 !important;
      padding:10px 18px !important;

      border-radius:12px !important;
      border:1px solid #e5e7eb !important;
      background:#ffffff !important;

      color:#111111 !important;
      font-weight:700 !important;
      text-decoration:none !important;

      cursor:pointer !important;
      transition: background .2s ease, color .2s ease, transform .1s ease !important;
    }

    a.see-more:hover{
      background:#ffcc00 !important;
      color:#000 !important;
      transform: translateY(-1px) !important;
    }
  </style>
</head>

<body>
  <div class="layout">

    <!-- Header / Topbar -->
    <header aria-label="Topo do aplicativo">
      <h1>
        <div aria-label="Site name" class="topbar__brand">
          Collecta<span class="topbar__dot">•</span>Hub
        </div>
      </h1>

      <div id="login-info" class="topbar-actions">
        <button type="button" class="btn btn--ghost" aria-label="Open profile" onclick="window.location.href='profile_page.php';">
          <svg aria-hidden="true" class="icon" role="img" viewBox="0 0 24 24">
            <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5.33 0-8 2.67-8 6v1h16v-1c0-3.33-2.67-6-8-6Z"></path>
          </svg>
          <span>Profile</span>
        </button>

        <!-- ✅ Logout (novo) -->
        <button
          type="button"
          class="btn btn--ghost"
          aria-label="Logout"
          title="Logout"
          onclick="window.location.href='logout.php';"
        >
          <svg aria-hidden="true" class="icon" role="img" viewBox="0 0 24 24">
            <path d="M10 17v-2h4v-6h-4V7l-5 5 5 5Zm9 4H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2v4h-2V5H5v14h14v-4h2v4c0 1.1-.9 2-2 2Z"></path>
          </svg>
          <span>Logout</span>
        </button>
      </div>
    </header>

    <!-- Sidebar -->
    <aside aria-label="Navegação lateral">
      <button id="create-collection" type="button">
        Create New Collection
      </button>

      <nav>
        <ul>
          <!-- ✅ REMOVIDO: Collector -->
          <li><a href="Homepage.login.html" data-nav="collector">Collector</a></li>

          <!-- ✅ REMOVIDO: Collections/Collection -->
          <!-- <li><a href="collection-page.html" data-nav="collections">Collections</a></li> -->

          <li><a href="event.html" data-nav="events">Events</a></li>
          <li><a href="team_page2.html" data-nav="community">Community</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main data-collection-id="default-collection" id="main-content">

      <section id="stats" aria-label="Estatísticas rápidas">
        <button type="button" aria-label="Total Collections">
          Total Collections: <span id="total-collections">0</span>
        </button>

        <button type="button" aria-label="Total Items">
          Total Items: <span id="total-items">0</span>
        </button>

        <button type="button" aria-label="Average Rating">
          Average Rating: <span id="average-rating">0</span>
        </button>
      </section>

      <section id="collections-list" aria-labelledby="collections-title">
        <h2 id="collections-title">Collections</h2>
        

        <!-- Cards entram aqui via JS -->

        <a href="#" class="see-more">See More</a>
      </section>

    </main>

    <footer>
      <p>&copy; 2025 Collecta•Hub — Team EIS_2526-G02-MEGI</p>
    </footer>

  </div>

  <!-- ✅ Métricas do dashboard -->
  <script>
    (function () {
      const metricsUrl = 'dashboard_metrics.php';

      async function loadDashboardMetrics() {
        try {
          const res = await fetch(metricsUrl, { credentials: 'same-origin' });
          if (res.status === 401) return;
          const data = await res.json();
          if (!data || data.success !== true) return;

          const m = data.metrics || {};
          const tc = document.getElementById('total-collections');
          const ti = document.getElementById('total-items');
          const ar = document.getElementById('average-rating');

          if (tc) tc.textContent = String(m.total_collections ?? 0);
          if (ti) ti.textContent = String(m.total_items ?? 0);
          if (ar) ar.textContent = String(m.average_rating ?? 0);
        } catch (e) {
          console.error('[home] metrics failed', e);
        }
      }

      document.addEventListener('DOMContentLoaded', loadDashboardMetrics);
    })();
  </script>

  <!-- ✅ MODAL “IGUAL DO ZIP” (COPIADO DO common/nav.js) + ENDPOINT CORRIGIDO -->
  <script>
    (function () {
      "use strict";

      const qs = (s, el=document) => el.querySelector(s);

      async function fetchText(url, opts = {}) {
        const res = await fetch(url, { credentials: "same-origin", cache: "no-store", ...opts });
        const text = await res.text();
        return { res, text };
      }
      function tryJson(t){ try { return JSON.parse(t); } catch { return null; } }

      async function apiPostForm(url, fd) {
        const { res, text } = await fetchText(url, { method: "POST", body: fd });
        const json = tryJson(text);
        if (!res.ok || !json || json.success !== true) {
          throw new Error((json && (json.error || json.message)) || `HTTP ${res.status}\n\n${text}`);
        }
        return json;
      }

      function ensureCreateCollectionModal() {
        let dlg = qs("#__create_collection_modal");
        if (dlg) return dlg;

        dlg = document.createElement("dialog");
        dlg.id = "__create_collection_modal";
        dlg.setAttribute("aria-label", "Create New Collection");
        Object.assign(dlg.style, {
          width: "min(640px, 92vw)",
          border: "1px solid rgba(0,0,0,.15)",
          borderRadius: "16px",
          padding: "0",
        });

        dlg.innerHTML = `
          <form id="__cc_form" method="dialog" enctype="multipart/form-data" style="padding:18px 18px 16px">
            <h3 style="margin:0 0 14px">Create New Collection</h3>

            <div style="display:grid; gap:10px">
              <label style="display:grid; gap:6px">
                <span style="font-weight:600">Name *</span>
                <input id="__cc_name" name="name" required type="text"
                       style="padding:10px;border:1px solid #ddd;border-radius:10px">
              </label>

              <label style="display:grid; gap:6px">
                <span style="font-weight:600">Type</span>
                <input id="__cc_type" name="type" type="text" placeholder="Miniatures, Cards..."
                       style="padding:10px;border:1px solid #ddd;border-radius:10px">
              </label>

              <label style="display:grid; gap:6px">
                <span style="font-weight:600">Creation date</span>
                <input id="__cc_date" name="creation_date" type="date"
                       style="padding:10px;border:1px solid #ddd;border-radius:10px">
              </label>

              <label style="display:grid; gap:6px">
                <span style="font-weight:600">Description</span>
                <textarea id="__cc_desc" name="description" rows="3"
                          style="padding:10px;border:1px solid #ddd;border-radius:10px;resize:vertical"></textarea>
              </label>

              <label style="display:grid; gap:6px">
                <span style="font-weight:600">Banner image (optional)</span>
                <input id="__cc_image" name="image" type="file" accept="image/*"
                       style="padding:10px;border:1px solid #ddd;border-radius:10px;background:#fff">
              </label>

              <div id="__cc_preview_wrap" style="display:none;margin-top:4px">
                <img id="__cc_preview" alt="Preview"
                     style="width:100%;max-height:220px;object-fit:cover;border-radius:12px;border:1px solid #ddd">
              </div>

              <p id="__cc_error" style="margin:6px 0 0;color:#B00020;font-weight:600"></p>
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px">
              <button type="button" id="__cc_cancel"
                      style="padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer">
                Cancel
              </button>
              <button type="submit" id="__cc_save"
                      style="padding:10px 14px;border-radius:10px;border:0;background:#111;color:#fff;cursor:pointer">
                Create
              </button>
            </div>
          </form>
        `;

        document.body.appendChild(dlg);

        const dateInput = qs("#__cc_date", dlg);
        if (dateInput && !dateInput.value) dateInput.value = new Date().toISOString().slice(0, 10);

        const file = qs("#__cc_image", dlg);
        const prevWrap = qs("#__cc_preview_wrap", dlg);
        const prevImg = qs("#__cc_preview", dlg);

        file.addEventListener("change", () => {
          const f = file.files && file.files[0];
          if (!f) {
            prevWrap.style.display = "none";
            prevImg.removeAttribute("src");
            return;
          }
          prevImg.src = URL.createObjectURL(f);
          prevWrap.style.display = "block";
        });

        qs("#__cc_cancel", dlg).addEventListener("click", () => dlg.close());

        return dlg;
      }

      async function createCollectionFromModal() {
        const dlg = ensureCreateCollectionModal();
        const errEl = qs("#__cc_error", dlg);
        errEl.textContent = "";

        const name = (qs("#__cc_name", dlg).value || "").trim();
        const type = (qs("#__cc_type", dlg).value || "").trim();
        const date = (qs("#__cc_date", dlg).value || "").trim();
        const desc = (qs("#__cc_desc", dlg).value || "").trim();

        if (!name) {
          errEl.textContent = "Name is required.";
          return;
        }

        try {
          const fd = new FormData();
          fd.append("action", "create");
          fd.append("name", name);
          fd.append("type", type);
          fd.append("creation_date", date || new Date().toISOString().slice(0, 10));
          fd.append("description", desc);

          const img = qs("#__cc_image", dlg);
          if (img && img.files && img.files[0]) fd.append("image", img.files[0]);

          const json = await apiPostForm("collections_api.php", fd);

          const created = json.collection || json;
          const newId = created.collection_id ?? json.collection_id ?? created.id ?? null;

          if (!newId) throw new Error("API não retornou collection_id.");

          window.dispatchEvent(new CustomEvent('collecta:collection-created', {
            detail: {
              collection_id: newId,
              name,
              type,
              creation_date: date,
              description: desc,
              image: created.image || created.cover_image || null
            }
          }));

          dlg.close();
          window.location.href = "collection-page.html?id=" + encodeURIComponent(newId);

        } catch (e) {
          console.error(e);
          errEl.textContent = String(e.message || e);
        }
      }

      function openCreateCollectionModal() {
        const dlg = ensureCreateCollectionModal();
        const form = qs("#__cc_form", dlg);

        if (!form.dataset.bound) {
          form.dataset.bound = "1";
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            await createCollectionFromModal();
          });
        }

        dlg.showModal();
      }

      document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("create-collection");
        if (!btn) return;

        btn.addEventListener("click", (e) => {
          e.preventDefault();
          openCreateCollectionModal();
        });
      });
    })();
  </script>

  <!-- Scripts do projeto -->
  <!-- ⚠️ Importante: não carregue common/nav.js aqui, senão você volta ao problema do endpoint errado e bindings duplicados -->
  <!-- <script src="common/nav.js" defer></script> -->

  <script src="scripthomelogin.js?v=999" defer></script>
</body>
</html>
