<!DOCTYPE html>
<html lang="en">
<head>
  <title>Events</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Global routing hints used by nav.js -->
  <meta name="app-base" content="">
  <meta name="item-page-path" content="index.html">
  <meta name="events-page-path" content="event.html">
  <meta name="collection-page-path" content="collection-page.html">
  <meta name="collectors-page-path" content="Homepage.login.html">
  <meta name="community-page-path" content="Team_page2.html">

  <!-- Styles -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="css/eventcss.css">
</head>
<body>
  <div class="entire-page">
    <!-- Sidebar with global nav targets -->
    <aside class="side-menu">
      <!-- ✅ Create (controlado por JS local - modal do ZIP).
           Removi data-nav="create" pra não conflitar com o nav.js -->
      <button class="new-collection" id="create-collection" type="button">
        Create New Collection
      </button>

      <!-- Primary navigation (pages) -->
      <nav class="nav" id="event-sidebar-nav">
        <!-- ✅ REMOVIDO: Collector -->
        <a class="nav-link" data-nav="collector" href="Homepage.login.html">Collector</a>

        <!-- ✅ REMOVIDO: Collections -->
        <!-- <a class="nav-link" data-nav="collections" href="collection-page.html">Collections</a> -->

        <a class="nav-link active" data-nav="events" href="event.html">Events</a>

        <a class="nav-link" data-nav="community" href="Team_page2.html">Community</a>
      </nav>
    </aside>

    <!-- Top bar with actions -->
    <header class="topmenu" role="banner">
      <!-- ✅ Logo clicável sem trocar tag / sem quebrar CSS -->
      <div class="brand"
           role="link"
           tabindex="0"
           style="cursor:pointer"
           onclick="window.location.href='Homepage.login.html';"
           onkeydown="if(event.key==='Enter' || event.key===' '){ event.preventDefault(); window.location.href='Homepage.login.html'; }">
        Collecta<span class="brand-dot">•</span>Hub
      </div>

      <nav class="actions">
        <button type="button" class="btn btn--ghost" aria-label="Open profile" onclick="window.location.href='profile_page.php';">
          <svg aria-hidden="true" class="icon" role="img" viewBox="0 0 24 24">
            <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5.33 0-8 2.67-8 6v1h16v-1c0-3.33-2.67-6-8-6Z"></path>
          </svg>
          <span>Profile</span>
        </button>

        <!-- ✅ Logout (novo) -->
        <button
          type="button"
          class="btn btn--ghost"
          aria-label="Logout"
          title="Logout"
          onclick="window.location.href='logout.php';"
        >
          <svg aria-hidden="true" class="icon" role="img" viewBox="0 0 24 24">
            <path d="M10 17v-2h4v-6h-4V7l-5 5 5 5Zm9 4H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2v4h-2V5H5v14h14v-4h2v4c0 1.1-.9 2-2 2Z"></path>
          </svg>
          <span>Logout</span>
        </button>
      </nav>
    </header>

    <!-- Main content -->
    <main id="main-content" class="middle" aria-label="Events main content">
      <div class="rank-add">
        <div class="filter">
          <button id="coming" class="filter-button" type="button">Coming</button>
          <button id="past" class="filter-button" type="button">Past</button>
          <button id="all" class="filter-button" type="button">All</button>
        </div>
        <button id="new-event" class="new-button" type="button">+New Event</button>
      </div>

      <div id="event-list" class="list"></div>

      <!-- Create/Edit dialog -->
      <dialog id="event-dialog">
        <form id="event-form" action="events_api.php" method="POST" enctype="multipart/form-data">
          <h3 id="form-title">New event</h3>

          <label>Collection*
            <select id="form-collection" name="collection" required>
              <option value="">-- Select collection --</option>
              <!-- Add more collections here -->
            </select>
          </label>

          <label>Name*
            <input type="text" id="form-name" name="name" required />
          </label>

          <label>Location*
            <input type="text" id="form-location" name="location" required />
          </label>

          <label>Date*
            <input type="date" id="form-date" name="date" required />
          </label>

          <label>Description*
            <textarea id="form-desc" name="description" required></textarea>
          </label>

          <div id="image-row">
            <label for="form-image">Image</label>
            <input id="form-image" name="image" type="file" accept="image/*">
          </div>

          <p id="form-error" aria-live="polite"></p>

          <div class="form-actions">
            <button id="cancel" type="button" value="cancel">Cancel</button>
            <button id="save" type="submit" value="default">Save</button>
          </div>
        </form>
      </dialog>
    </main>
  </div>

  <!-- Details dialog -->
  <dialog id="detail-dialog">
    <article class="event-details">
      <img id="detail-image"
           src="data:image/gif;base64,R0lGODlhAQABAAAAACw="
           alt=""
           style="display:none" />
      <div class="event-details-body">
        <h2 id="detail-title">Event details</h2>
        <div class="details-chips">
          <span id="detail-collection" class="chip"></span>
          <span id="detail-date" class="chip"></span>
          <span id="detail-location" class="chip"></span>
          <span id="detail-rating" class="chip"></span>
        </div>
        <p id="detail-desc"></p>
        <div class="dialog-actions">
          <button id="detail-close" value="cancel">Close</button>
        </div>
      </div>
    </article>
  </dialog>

  <!-- Card template -->
  <template id="events">
    <article class="event-posts">
      <img class="event-picture" src="images/default.jpg" alt="Event image">

      <div class="event-content">
        <div class="event-post-title">
          <span class="badge"></span>
        </div>

        <div class="event-post-body">
          <h3 class="event-title"></h3>
          <div class="event-info">
            <div class="chip">
              <span class="chip-date">Date:</span>
              <span class="chip-location">Location:</span>
            </div>
          </div>
        </div>

        <div class="post-actions">
          <button class="edit-button" type="button">Edit</button>
          <button class="delete-button" type="button">Delete</button>
        </div>
      </div>

      <div class="rating" aria-label="Rate this event">
        <span class="star" data-value="1" aria-hidden="true">*</span>
        <span class="star" data-value="2" aria-hidden="true">*</span>
        <span class="star" data-value="3" aria-hidden="true">*</span>
        <span class="star" data-value="4" aria-hidden="true">*</span>
        <span class="star" data-value="5" aria-hidden="true">*</span>
      </div>
    </article>
  </template>

  <!-- Scripts -->
  <script src="common/nav.js" defer></script>
  <script src="js/eventjs.js" defer></script>

  <!-- ✅ CREATE COLLECTION MODAL (MESMO DO ZIP) + ENDPOINT CORRETO -->
  <script>
    (function () {
      "use strict";

      const qs = (s, el=document) => el.querySelector(s);

      async function fetchText(url, opts = {}) {
        const res = await fetch(url, { credentials: "same-origin", cache: "no-store", ...opts });
        const text = await res.text();
        return { res, text };
      }
      function tryJson(t){ try { return JSON.parse(t); } catch { return null; } }

      async function apiPostForm(url, fd) {
        const { res, text } = await fetchText(url, { method: "POST", body: fd });
        const json = tryJson(text);
        if (!res.ok || !json || json.success !== true) {
          throw new Error((json && (json.error || json.message)) || `HTTP ${res.status}\n\n${text}`);
        }
        return json;
      }

      function ensureCreateCollectionModal() {
        let dlg = qs("#__create_collection_modal");
        if (dlg) return dlg;

        dlg = document.createElement("dialog");
        dlg.id = "__create_collection_modal";
        dlg.setAttribute("aria-label", "Create New Collection");
        Object.assign(dlg.style, {
          width: "min(640px, 92vw)",
          border: "1px solid rgba(0,0,0,.15)",
          borderRadius: "16px",
          padding: "0",
        });

        dlg.innerHTML = `
          <form id="__cc_form" method="dialog" enctype="multipart/form-data" style="padding:18px 18px 16px">
            <h3 style="margin:0 0 14px">Create New Collection</h3>

            <div style="display:grid; gap:10px">
              <label style="display:grid; gap:6px">
                <span style="font-weight:600">Name *</span>
                <input id="__cc_name" name="name" required type="text"
                       style="padding:10px;border:1px solid #ddd;border-radius:10px">
              </label>

              <label style="display:grid; gap:6px">
                <span style="font-weight:600">Type</span>
                <input id="__cc_type" name="type" type="text" placeholder="Miniatures, Cards..."
                       style="padding:10px;border:1px solid #ddd;border-radius:10px">
              </label>

              <label style="display:grid; gap:6px">
                <span style="font-weight:600">Creation date</span>
                <input id="__cc_date" name="creation_date" type="date"
                       style="padding:10px;border:1px solid #ddd;border-radius:10px">
              </label>

              <label style="display:grid; gap:6px">
                <span style="font-weight:600">Description</span>
                <textarea id="__cc_desc" name="description" rows="3"
                          style="padding:10px;border:1px solid #ddd;border-radius:10px;resize:vertical"></textarea>
              </label>

              <label style="display:grid; gap:6px">
                <span style="font-weight:600">Banner image (optional)</span>
                <input id="__cc_image" name="image" type="file" accept="image/*"
                       style="padding:10px;border:1px solid #ddd;border-radius:10px;background:#fff">
              </label>

              <div id="__cc_preview_wrap" style="display:none;margin-top:4px">
                <img id="__cc_preview" alt="Preview"
                     style="width:100%;max-height:220px;object-fit:cover;border-radius:12px;border:1px solid #ddd">
              </div>

              <p id="__cc_error" style="margin:6px 0 0;color:#B00020;font-weight:600"></p>
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px">
              <button type="button" id="__cc_cancel"
                      style="padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer">
                Cancel
              </button>
              <button type="submit" id="__cc_save"
                      style="padding:10px 14px;border-radius:10px;border:0;background:#111;color:#fff;cursor:pointer">
                Create
              </button>
            </div>
          </form>
        `;

        document.body.appendChild(dlg);

        const dateInput = qs("#__cc_date", dlg);
        if (dateInput && !dateInput.value) dateInput.value = new Date().toISOString().slice(0, 10);

        const file = qs("#__cc_image", dlg);
        const prevWrap = qs("#__cc_preview_wrap", dlg);
        const prevImg = qs("#__cc_preview", dlg);

        file.addEventListener("change", () => {
          const f = file.files && file.files[0];
          if (!f) {
            prevWrap.style.display = "none";
            prevImg.removeAttribute("src");
            return;
          }
          prevImg.src = URL.createObjectURL(f);
          prevWrap.style.display = "block";
        });

        qs("#__cc_cancel", dlg).addEventListener("click", () => dlg.close());
        return dlg;
      }

      async function createCollectionFromModal() {
        const dlg = ensureCreateCollectionModal();
        const errEl = qs("#__cc_error", dlg);
        errEl.textContent = "";

        const name = (qs("#__cc_name", dlg).value || "").trim();
        const type = (qs("#__cc_type", dlg).value || "").trim();
        const date = (qs("#__cc_date", dlg).value || "").trim();
        const desc = (qs("#__cc_desc", dlg).value || "").trim();

        if (!name) { errEl.textContent = "Name is required."; return; }

        try {
          const fd = new FormData();
          fd.append("action", "create");
          fd.append("name", name);
          fd.append("type", type);
          fd.append("creation_date", date || new Date().toISOString().slice(0, 10));
          fd.append("description", desc);

          const img = qs("#__cc_image", dlg);
          if (img && img.files && img.files[0]) fd.append("image", img.files[0]);

          const json = await apiPostForm("collections_api.php", fd);

          const created = json.collection || json;
          const newId = created.collection_id ?? json.collection_id ?? created.id ?? null;
          if (!newId) throw new Error("API did not return collection_id.");

          dlg.close();
          window.location.href = "collection-page.html?id=" + encodeURIComponent(newId);
        } catch (e) {
          console.error(e);
          errEl.textContent = String(e.message || e);
        }
      }

      function openCreateCollectionModal() {
        const dlg = ensureCreateCollectionModal();
        const form = qs("#__cc_form", dlg);

        if (!form.dataset.bound) {
          form.dataset.bound = "1";
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            await createCollectionFromModal();
          });
        }

        dlg.showModal();
      }

      document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("create-collection");
        if (!btn) return;
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          openCreateCollectionModal();
        });
      });
    })();
  </script>

  <!-- Mantive o seu bloco grande de patch de upload/eventos INTACTO (mínima alteração) -->
  <script>
  (() => {
    "use strict";

    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));
    const getMeta = (name, fallback="") =>
      (document.querySelector(`meta[name="${name}"]`)?.getAttribute("content") ?? fallback).toString();

    const APP_BASE = getMeta("app-base", "").replace(/\/+$/, "");
    const EVENTS_PAGE_PATH = getMeta("events-page-path", "event.html").replace(/^\/+/, "");
    const withBase = (p) => (APP_BASE ? `${APP_BASE}/` : "") + p;

    function getCollectionId() {
      const main = qs("#main-content");
      const urlParams = new URLSearchParams(location.search);
      return urlParams.get("id") || main?.dataset?.collectionId || "demo-collection";
    }

    function buildEventsUrl() {
      const cid = getCollectionId();
      return withBase(`${EVENTS_PAGE_PATH}?c=${encodeURIComponent(cid)}`);
    }

    function toast(msg, type="info") {
      let root = qs("#__patch_toast");
      if (!root) {
        root = document.createElement("div");
        root.id = "__patch_toast";
        Object.assign(root.style, {
          position:"fixed", right:"16px", bottom:"16px", zIndex: 100000,
          display:"flex", flexDirection:"column", gap:"8px"
        });
        document.body.appendChild(root);
      }
      const el = document.createElement("div");
      el.textContent = msg;
      Object.assign(el.style, {
        background: type==="error" ? "#B00020" : type==="success" ? "#0B8A83" : "#333",
        color:"#fff", padding:"10px 14px", borderRadius:"10px",
        boxShadow:"0 8px 24px rgba(0,0,0,.2)", fontSize:"14px", maxWidth:"340px"
      });
      root.appendChild(el);
      setTimeout(() => {
        el.style.opacity="0"; el.style.transform="translateY(6px)"; el.style.transition="all .25s ease";
        setTimeout(() => el.remove(), 250);
      }, 2200);
    }

    const UPLOAD_MARK = "data-event-upload-patched";

    function findCreateEventForm() {
      const dialogs = qsa('[role="dialog"][aria-modal="true"]');
      for (const d of dialogs) {
        const h2 = qsa("h2", d).find(x => (x.textContent || "").trim().toLowerCase() === "create event");
        if (!h2) continue;
        const form = qs("form", d);
        if (form) return form;
      }
      return null;
    }

    function injectUploadUI(form) {
      if (!form || form.getAttribute(UPLOAD_MARK) === "1") return;

      const textarea = qs('textarea[name="description"]', form) || qs("textarea", form);
      const holder = document.createElement("div");
      holder.className = "event-upload";
      holder.innerHTML = `
        <div style="margin:8px 0 12px">
          <label for="__event_image_input" style="display:block;font-weight:600;margin-bottom:6px">
            Event image (optional)
          </label>

          <input
            id="__event_image_input"
            name="image"
            type="file"
            accept="image/*"
            style="display:block !important; width:100% !important; padding:10px !important;
                   border:1px solid #ddd !important; border-radius:10px !important;
                   background:#fff !important; opacity:1 !important; visibility:visible !important;
                   position:static !important; pointer-events:auto !important;"
          />

          <div id="__event_image_preview_wrap" style="margin-top:10px;display:none">
            <img
              id="__event_image_preview"
              alt="Preview"
              style="width:100%;max-height:220px;object-fit:cover;border-radius:12px;border:1px solid #ddd;display:block"
            />
          </div>

          <small style="display:block;margin-top:6px;opacity:.75">
            Upload an image from your computer (JPG/PNG/WebP).
          </small>
        </div>
      `;

      if (textarea && textarea.parentNode) {
        textarea.parentNode.insertBefore(holder, textarea);
      } else {
        form.appendChild(holder);
      }

      const input = qs("#__event_image_input", form);
      const prevWrap = qs("#__event_image_preview_wrap", form);
      const prevImg = qs("#__event_image_preview", form);

      input.addEventListener("change", () => {
        const file = input.files && input.files[0];
        if (!file) {
          prevWrap.style.display = "none";
          prevImg.removeAttribute("src");
          return;
        }
        prevImg.src = URL.createObjectURL(file);
        prevWrap.style.display = "block";
      });

      form.setAttribute(UPLOAD_MARK, "1");
    }

    function attachSubmitOverride(form) {
      if (!form || form.dataset.submitPatched === "1") return;
      form.dataset.submitPatched = "1";

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        e.stopImmediatePropagation();

        const cid = getCollectionId();

        const name = (qs('input[name="name"]', form)?.value || "").trim();
        const location = (qs('input[name="location"]', form)?.value || "").trim();
        const date = (qs('input[name="date"]', form)?.value || "").trim();
        const description = (qs('textarea[name="description"]', form)?.value || "").trim();

        if (!name || !location || !date) {
          toast("Fill in Event name, Location and Date.", "error");
          return;
        }

        try {
          const fd = new FormData();
          fd.append("action", "create");
          fd.append("collection", cid);
          fd.append("name", name);
          fd.append("location", location);
          fd.append("date", date);
          fd.append("description", description || `Event related to collection "${cid}".`);

          const fileInput = qs("#__event_image_input", form) || qs('input[type="file"][name="image"]', form);
          if (fileInput && fileInput.files && fileInput.files[0]) {
            fd.append("image", fileInput.files[0]);
          }

          const res = await fetch("events_api.php", { method: "POST", body: fd });
          const json = await res.json().catch(() => ({}));

          if (!res.ok || !json.success) {
            throw new Error(json.error || "Could not create event.");
          }

          toast("Event created.", "success");
          location.href = buildEventsUrl();
        } catch (err) {
          console.error(err);
          toast("Could not create event.", "error");
        }
      }, true);
    }

    function patchIfNeeded() {
      const form = findCreateEventForm();
      if (!form) return;
      injectUploadUI(form);
      attachSubmitOverride(form);
    }

    patchIfNeeded();
    const mo = new MutationObserver(() => patchIfNeeded());
    mo.observe(document.body, { childList: true, subtree: true });

  })();
  </script>

</body>
</html>
